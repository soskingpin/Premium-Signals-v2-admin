<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Forex Signals Admin</title>
    <style>
        * { box-sizing: border-box; font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif; transition: all 0.3s ease; }
        body { background: #0f0f1b; color: #e0e0e0; margin: 0; padding: 0; min-height: 100vh; }
        .login-container { 
            width: 100%; 
            max-width: 400px; 
            background: #151729; 
            padding: 40px; 
            border-radius: 15px; 
            box-shadow: 0 0 30px rgba(78, 205, 196, 0.2);
            margin: 50px auto; 
            border: 1px solid rgba(78, 205, 196, 0.1);
            position: relative;
            overflow: hidden;
        }
        
        .login-container::before {
            content: '';
            position: absolute;
            top: -50%;
            left: -50%;
            width: 200%;
            height: 200%;
            background: radial-gradient(circle, rgba(78, 205, 196, 0.05) 0%, transparent 70%);
            z-index: -1;
            pointer-events: none;
        }
        
        .dashboard-container { display: none; max-width: 1200px; margin: 20px auto; padding: 0 20px; }
        header { 
            background: #151729; 
            padding: 15px 20px; 
            display: flex; 
            justify-content: space-between; 
            align-items: center;
            border-radius: 10px;
            margin: 0 20px;
            box-shadow: 0 5px 15px rgba(0,0,0,0.3);
            border: 1px solid rgba(78, 205, 196, 0.1);
        }
        .logo { 
            color: #4ecdc4; 
            font-size: 1.5rem; 
            font-weight: bold; 
            text-shadow: 0 0 10px rgba(78, 205, 196, 0.3);
        }
        .logout-btn { 
            background: linear-gradient(45deg, #ff6b6b, #c0392b); 
            color: white; 
            border: none; 
            padding: 8px 15px; 
            border-radius: 6px; 
            cursor: pointer;
            box-shadow: 0 4px 10px rgba(255, 107, 107, 0.3);
        }
        .logout-btn:hover {
            transform: translateY(-2px);
            box-shadow: 0 7px 15px rgba(255, 107, 107, 0.4);
        }
        .card { 
            background: #151729; 
            border-radius: 12px; 
            padding: 20px; 
            margin-bottom: 20px;
            box-shadow: 0 5px 15px rgba(0,0,0,0.3);
            border: 1px solid rgba(78, 205, 196, 0.1);
            position: relative;
            overflow: hidden;
        }
        .card::before {
            content: '';
            position: absolute;
            top: 0;
            left: 0;
            width: 4px;
            height: 100%;
            background: linear-gradient(to bottom, #4ecdc4, #1a936f);
        }
        h2 { 
            color: #4ecdc4; 
            margin-top: 0; 
            font-weight: 600;
            text-shadow: 0 0 5px rgba(78, 205, 196, 0.2);
        }
        .key-generator, .signal-generator { display: flex; flex-direction: column; gap: 15px; }
        .key-row, .signal-row { display: flex; gap: 10px; align-items: center; }
        input, select, button { padding: 10px; border-radius: 6px; }
        input, select { 
            flex: 1; 
            background: #121423; 
            border: 1px solid #2d314d; 
            color: white; 
            transition: all 0.3s;
        }
        input:focus, select:focus {
            outline: none;
            border-color: #4ecdc4;
            box-shadow: 0 0 0 3px rgba(78, 205, 196, 0.2);
        }
        button { 
            background: linear-gradient(45deg, #4ecdc4, #1a936f); 
            color: #0f0f1b; 
            border: none; 
            cursor: pointer; 
            font-weight: bold; 
            box-shadow: 0 4px 10px rgba(78, 205, 196, 0.3);
            transition: all 0.3s;
        }
        button:hover { 
            transform: translateY(-2px);
            box-shadow: 0 7px 15px rgba(78, 205, 196, 0.4);
        }
        button:active {
            transform: translateY(0);
        }
        table { 
            width: 100%; 
            border-collapse: collapse; 
            margin-top: 20px; 
            border-radius: 10px;
            overflow: hidden;
        }
        th, td { 
            padding: 12px 15px; 
            text-align: left; 
            border-bottom: 1px solid #2d314d; 
            border-right: 1px solid #2d314d;
        }
        th:last-child, td:last-child {
            border-right: none;
        }
        th { 
            background: #121423; 
            color: #4ecdc4; 
            font-weight: 600;
        }
        tr:hover { 
            background: rgba(78, 205, 196, 0.05); 
        }
        .status { 
            padding: 5px 10px; 
            border-radius: 20px; 
            font-size: 0.85rem; 
            display: inline-block;
        }
        .status.active { 
            background: rgba(46, 204, 113, 0.2); 
            color: #2ecc71; 
        }
        .status.expired { 
            background: rgba(231, 76, 60, 0.2); 
            color: #e74c3c; 
        }
        .status.revoked { 
            background: rgba(108, 117, 125, 0.2); 
            color: #6c757d; 
        }
        .action-btn { 
            background: none; 
            border: none; 
            color: #4ecdc4; 
            cursor: pointer; 
            margin-right: 5px; 
            font-weight: 500;
            transition: all 0.3s;
        }
        .action-btn:hover {
            color: #1a936f;
            text-decoration: underline;
        }
        .duration-help, .signal-help { 
            font-size: 0.85rem; 
            color: #aaa; 
            margin-top: 5px; 
        }
        .error { 
            color: #ff6b6b; 
            text-align: center; 
            margin-top: 15px; 
        }
        .success { 
            color: #4ecdc4; 
            text-align: center; 
            margin-top: 15px; 
        }
        .modal { 
            display: none; 
            position: fixed; 
            top: 0; 
            left: 0; 
            width: 100%; 
            height: 100%; 
            background: rgba(0,0,0,0.85); 
            z-index: 1000; 
            justify-content: center;
            align-items: center;
            animation: modalFadeIn 0.4s;
        }
        @keyframes modalFadeIn {
            from { opacity: 0; }
            to { opacity: 1; }
        }
        .modal-content { 
            background: #151729; 
            margin: 10% auto; 
            padding: 20px; 
            width: 500px; 
            border-radius: 12px;
            border: 1px solid rgba(78, 205, 196, 0.1);
            box-shadow: 0 0 50px rgba(78, 205, 196, 0.2);
            position: relative;
            overflow: hidden;
        }
        .modal-content::before {
            content: '';
            position: absolute;
            top: 0;
            left: 0;
            width: 4px;
            height: 100%;
            background: linear-gradient(to bottom, #4ecdc4, #1a936f);
        }
        .close { 
            color: #aaa; 
            float: right; 
            font-size: 28px; 
            font-weight: bold; 
            position: absolute;
            top: 15px;
            right: 20px;
            cursor: pointer;
            transition: all 0.3s;
        }
        .close:hover { 
            color: #4ecdc4; 
            transform: scale(1.1);
        }
        .license-keys-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 10px;
        }
        .view-all-btn {
            background: none;
            border: none;
            color: #4ecdc4;
            cursor: pointer;
            font-weight: 500;
            transition: all 0.3s;
        }
        .view-all-btn:hover {
            color: #1a936f;
            text-decoration: underline;
        }
        .recent-keys-only {
            max-height: 300px;
            overflow-y: auto;
        }
        .recent-keys-only::-webkit-scrollbar {
            width: 6px;
        }
        .recent-keys-only::-webkit-scrollbar-track {
            background: #121423;
            border-radius: 3px;
        }
        .recent-keys-only::-webkit-scrollbar-thumb {
            background: #4ecdc4;
            border-radius: 3px;
        }
        .key-management-section {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 15px;
        }
        .key-limit-info {
            font-size: 0.85rem;
            color: #aaa;
        }
    </style>
</head>
<body>
    <!-- Login Page -->
    <div id="loginPage" class="login-container">
        <h2 style="text-align: center; color: #4ecdc4; margin-bottom: 30px; font-weight: 700;">Admin Login</h2>
        <div class="form-group">
            <label for="username">Username</label>
            <input type="text" id="username" placeholder="admin">
        </div>
        <div class="form-group">
            <label for="password">Password</label>
            <input type="password" id="password" placeholder="••••••••">
        </div>
        <button onclick="loginAdmin()" style="width: 100%; padding: 12px; margin-top: 10px; font-weight: 600;">Login</button>
        <div id="message" class="error" style="display: none;"></div>
    </div>

    <!-- Dashboard Page -->
    <div id="dashboardPage">
        <header>
            <div class="logo">Forex Signals Admin</div>
            <button class="logout-btn" onclick="logout()">Logout</button>
        </header>

        <div class="dashboard-container">
            <div class="card">
                <h2>Generate License Key</h2>
                <div class="key-generator">
                    <div class="key-row">
                        <input type="text" id="newKey" readonly placeholder="Generate a new key">
                        <button onclick="generateKey()" style="padding: 10px 15px; flex: 0 0 auto;">Generate</button>
                    </div>
                    
                    <div class="key-row">
                        <select id="durationValue" style="flex: 1;">
                            <option value="1">1</option>
                            <option value="2">2</option>
                            <option value="3">3</option>
                            <option value="4">4</option>
                            <option value="5">5</option>
                            <option value="7" selected>7</option>
                            <option value="10">10</option>
                            <option value="15">15</option>
                            <option value="30">30</option>
                            <option value="60">60</option>
                            <option value="90">90</option>
                        </select>
                        
                        <select id="durationUnit" style="flex: 1;">
                            <option value="seconds">Seconds</option>
                            <option value="minutes">Minutes</option>
                            <option value="hours">Hours</option>
                            <option value="days" selected>Days</option>
                            <option value="weeks">Weeks</option>
                            <option value="months">Months</option>
                        </select>
                        
                        <button onclick="saveKey()" style="flex: 1; padding: 10px 15px;">Activate Key</button>
                    </div>
                    
                    <div class="duration-help">
                        Tip: For subscriptions, 30 days is common. For trials, 7 days works well.
                    </div>
                    
                    <div id="keyMessage" class="success" style="display: none; margin-top: 10px;"></div>
                </div>
            </div>
            
            <div class="card">
                <h2>Add New Signal</h2>
                <button onclick="openSignalModal()" style="width: 100%; padding: 12px; background: linear-gradient(45deg, #4ecdc4, #1a936f); color: #0f0f1b; border: none; border-radius: 6px; cursor: pointer; font-weight: bold; margin-bottom: 20px; font-weight: 600; box-shadow: 0 4px 10px rgba(78, 205, 196, 0.3);">
                    + Add New Signal
                </button>
                
                <div class="signal-help">
                    Use this form to add new forex signals for your users.
                </div>
            </div>
            
            <div class="card">
                <div class="key-management-section">
                    <h2>License Keys Management</h2>
                    <span class="key-limit-info">Showing last 3 active keys</span>
                </div>
                <div class="recent-keys-only">
                    <table id="keysTable">
                        <thead>
                            <tr>
                                <th>License Key</th>
                                <th>Status</th>
                                <th>Created</th>
                                <th>Expires</th>
                                <th>Actions</th>
                            </tr>
                        </thead>
                        <tbody>
                        </tbody>
                    </table>
                </div>
            </div>
            
            <div class="card">
                <h2>Active Signals</h2>
                <table id="signalsTable">
                    <thead>
                        <tr>
                            <th>Pair</th>
                            <th>Type</th>
                            <th>Entry</th>
                            <th>TP</th>
                            <th>SL</th>
                            <th>Timeframe</th>
                            <th>Created</th>
                            <th>Actions</th>
                        </tr>
                    </thead>
                    <tbody>
                    </tbody>
                </table>
            </div>
        </div>
    </div>
    
    <!-- Signal Modal -->
    <div id="signalModal" class="modal">
        <div class="modal-content">
            <span class="close" onclick="closeSignalModal()">&times;</span>
            <h2 style="color: #4ecdc4; margin-top: 0; margin-bottom: 20px;">Add New Signal</h2>
            
            <div class="signal-generator" style="gap: 15px;">
                <div class="signal-row">
                    <label style="width: 100px;">Currency Pair:</label>
                    <input type="text" id="signalPair" placeholder="EUR/USD">
                </div>
                
                <div class="signal-row">
                    <label style="width: 100px;">Signal Type:</label>
                    <select id="signalType">
                        <option value="buy">Buy</option>
                        <option value="sell">Sell</option>
                    </select>
                </div>
                
                <div class="signal-row">
                    <label style="width: 100px;">Entry Price:</label>
                    <input type="text" id="signalEntry" placeholder="1.0850">
                </div>
                
                <div class="signal-row">
                    <label style="width: 100px;">Take Profit:</label>
                    <input type="text" id="signalTP" placeholder="1.0920">
                </div>
                
                <div class="signal-row">
                    <label style="width: 100px;">Stop Loss:</label>
                    <input type="text" id="signalSL" placeholder="1.0810">
                </div>
                
                <div class="signal-row">
                    <label style="width: 100px;">Timeframe:</label>
                    <select id="signalTimeframe">
                        <option value="M5">M5</option>
                        <option value="M15">M15</option>
                        <option value="M30">M30</option>
                        <option value="H1" selected>H1</option>
                        <option value="H4">H4</option>
                        <option value="D1">D1</option>
                    </select>
                </div>
                
                <div class="signal-row">
                    <label style="width: 100px;">Additional Note:</label>
                    <input type="text" id="signalNote" placeholder="Optional note">
                </div>
                
                <button onclick="saveSignal()" style="width: 100%; padding: 12px; background: linear-gradient(45deg, #4ecdc4, #1a936f); color: #0f0f1b; border: none; border-radius: 4px; cursor: pointer; font-weight: bold; font-weight: 600; box-shadow: 0 4px 10px rgba(78, 205, 196, 0.3);">
                    Save Signal
                </button>
            </div>
        </div>
    </div>

    <!-- Firebase SDK -->
    <script src="https://www.gstatic.com/firebasejs/9.22.0/firebase-app-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/9.22.0/firebase-firestore-compat.js"></script>
    <script>
        // Your Firebase config
        const firebaseConfig = {
            apiKey: "AIzaSyA6A67d0YBJlhcT9GUGRVHMzGue1BM2rsA",
            authDomain: "forex-signals-platform.firebaseapp.com",
            projectId: "forex-signals-platform",
            storageBucket: "forex-signals-platform.firebasestorage.app",
            messagingSenderId: "655334374318",
            appId: "1:655334374318:web:d107dbf37ab1e31e1c663f",
            measurementId: "G-P7RWPEPQ4V"
        };
        
        // Initialize Firebase
        firebase.initializeApp(firebaseConfig);
        const db = firebase.firestore();

        // Check if admin is already logged in
        document.addEventListener('DOMContentLoaded', function() {
            if (localStorage.getItem('forex_admin') === 'true') {
                showDashboard();
            }
        });

        function loginAdmin() {
            const username = document.getElementById('username').value;
            const password = document.getElementById('password').value;
            
            if (username === 'admin' && password === 'admin###') {
                localStorage.setItem('forex_admin', 'true');
                showDashboard();
            } else {
                showMessage('Invalid credentials', 'error');
            }
        }

        function showDashboard() {
            document.getElementById('loginPage').style.display = 'none';
            document.getElementById('dashboardPage').style.display = 'block';
            document.querySelector('.dashboard-container').style.display = 'block';
            loadRecentKeys();
            loadSignals();
        }

        function logout() {
            localStorage.removeItem('forex_admin');
            document.getElementById('dashboardPage').style.display = 'none';
            document.getElementById('loginPage').style.display = 'block';
        }

        // Generate random license key
        function generateKey() {
            const chars = 'ABCDEFGHJKLMNPQRSTUVWXYZ23456789';
            let key = '';
            for (let i = 0; i < 16; i++) {
                key += chars.charAt(Math.floor(Math.random() * chars.length));
                if ((i + 1) % 4 === 0 && i !== 15) key += '-';
            }
            document.getElementById('newKey').value = key;
            showMessage('Key generated! Select duration and click "Activate Key"', 'success');
        }

        function saveKey() {
            const keyInput = document.getElementById('newKey').value;
            const durationValue = parseInt(document.getElementById('durationValue').value);
            const durationUnit = document.getElementById('durationUnit').value;
            
            if (!keyInput) {
                showMessage('Generate a key first', 'error');
                return;
            }
            
            if (!durationValue || !durationUnit) {
                showMessage('Please select a valid duration', 'error');
                return;
            }

            const formattedKey = keyInput.replace(/[^A-Z0-9]/gi, '')
                .replace(/(.{4})/g, '$1-')
                .slice(0, 19)
                .toUpperCase();

            // Calculate expiration date based on selected duration
            const now = new Date();
            let expiresAt = new Date(now);
            
            switch(durationUnit) {
                case 'seconds':
                    expiresAt.setSeconds(now.getSeconds() + durationValue);
                    break;
                case 'minutes':
                    expiresAt.setMinutes(now.getMinutes() + durationValue);
                    break;
                case 'hours':
                    expiresAt.setHours(now.getHours() + durationValue);
                    break;
                case 'days':
                    expiresAt.setDate(now.getDate() + durationValue);
                    break;
                case 'weeks':
                    expiresAt.setDate(now.getDate() + (durationValue * 7));
                    break;
                case 'months':
                    expiresAt.setMonth(now.getMonth() + durationValue);
                    break;
            }
            
            // Save to Firestore
            db.collection('licenseKeys').add({
                key: formattedKey,
                status: 'active',
                createdAt: firebase.firestore.FieldValue.serverTimestamp(),
                createdBy: 'admin',
                expiresAt: firebase.firestore.Timestamp.fromDate(expiresAt),
                durationValue: durationValue,
                durationUnit: durationUnit
            })
            .then(() => {
                document.getElementById('newKey').value = '';
                loadRecentKeys();
                showMessage('Key activated successfully!', 'success');
            })
            .catch((error) => {
                console.error("Error saving key: ", error);
                showMessage('Error saving key: ' + error.message, 'error');
            });
        }

        function revokeKey(keyId) {
            if (!confirm('Are you sure you want to revoke this license key?')) {
                return;
            }
            
            db.collection('licenseKeys').doc(keyId).update({
                status: 'revoked',
                revokedAt: firebase.firestore.FieldValue.serverTimestamp()
            })
            .then(() => {
                loadRecentKeys();
                showMessage('Key revoked', 'success');
            })
            .catch((error) => {
                console.error("Error revoking key: ", error);
                showMessage('Error revoking key: ' + error.message, 'error');
            });
        }
        
        function loadAllKeys() {
            const modal = document.createElement('div');
            modal.style.position = 'fixed';
            modal.style.top = '0';
            modal.style.left = '0';
            modal.style.width = '100%';
            modal.style.height = '100%';
            modal.style.background = 'rgba(0,0,0,0.85)';
            modal.style.zIndex = '2000';
            modal.style.overflow = 'auto';
            
            const content = document.createElement('div');
            content.style.background = '#151729';
            content.style.margin = '50px auto';
            content.style.width = '90%';
            content.style.maxWidth = '1200px';
            content.style.borderRadius = '12px';
            content.style.padding = '20px';
            content.style.position = 'relative';
            
            const closeBtn = document.createElement('span');
            closeBtn.innerHTML = '&times;';
            closeBtn.style.position = 'absolute';
            closeBtn.style.top = '15px';
            closeBtn.style.right = '20px';
            closeBtn.style.color = '#aaa';
            closeBtn.style.fontSize = '28px';
            closeBtn.style.cursor = 'pointer';
            closeBtn.style.transition = 'all 0.3s';
            closeBtn.onmouseover = () => closeBtn.style.color = '#4ecdc4';
            closeBtn.onclick = () => document.body.removeChild(modal);
            
            const title = document.createElement('h2');
            title.textContent = 'All License Keys';
            title.style.color = '#4ecdc4';
            title.style.marginTop = '0';
            
            const table = document.createElement('table');
            table.style.width = '100%';
            table.style.borderCollapse = 'collapse';
            table.style.marginTop = '20px';
            
            const thead = document.createElement('thead');
            thead.innerHTML = `
                <tr>
                    <th>License Key</th>
                    <th>Status</th>
                    <th>Created</th>
                    <th>Expires</th>
                    <th>Actions</th>
                </tr>
            `;
            
            const tbody = document.createElement('tbody');
            
            // Load all keys
            db.collection('licenseKeys')
                .orderBy('createdAt', 'desc')
                .get()
                .then((querySnapshot) => {
                    querySnapshot.forEach((doc) => {
                        const data = doc.data();
                        const createdAt = data.createdAt?.toDate().toLocaleString() || 'N/A';
                        
                        let expiresAt = 'N/A';
                        let statusClass = 'status ' + data.status;
                        
                        if (data.expiresAt) {
                            const expiresDate = data.expiresAt.toDate();
                            expiresAt = expiresDate.toLocaleString();
                        }
                        
                        const row = document.createElement('tr');
                        row.innerHTML = `
                            <td>${data.key}</td>
                            <td><span class="${statusClass}">${data.status}</span></td>
                            <td>${createdAt}</td>
                            <td>${expiresAt}</td>
                            <td>
                                ${data.status === 'active' ? 
                                    `<button class="action-btn" onclick="revokeKey('${doc.id}')">Revoke</button>` : 
                                    'Revoked'}
                            </td>
                        `;
                        tbody.appendChild(row);
                    });
                })
                .catch((error) => {
                    console.error("Error loading keys: ", error);
                    const row = document.createElement('tr');
                    row.innerHTML = `<td colspan="5" style="color: #ff6b6b; text-align: center;">Error loading keys: ${error.message}</td>`;
                    tbody.appendChild(row);
                });
            
            table.appendChild(thead);
            table.appendChild(tbody);
            content.appendChild(closeBtn);
            content.appendChild(title);
            content.appendChild(table);
            modal.appendChild(content);
            document.body.appendChild(modal);
        }

        function loadRecentKeys() {
            db.collection('licenseKeys')
                .orderBy('createdAt', 'desc')
                .get()
                .then((querySnapshot) => {
                    const tbody = document.querySelector('#keysTable tbody');
                    tbody.innerHTML = '';
                    
                    // Get only the last 3 active keys
                    const activeKeys = [];
                    querySnapshot.forEach((doc) => {
                        const data = doc.data();
                        if (data.status === 'active') {
                            activeKeys.push({id: doc.id,  data});
                        }
                    });
                    
                    // Take only the last 3
                    const recentKeys = activeKeys.slice(0, 3);
                    
                    recentKeys.forEach(item => {
                        const data = item.data;
                        const createdAt = data.createdAt?.toDate().toLocaleString() || 'N/A';
                        
                        let expiresAt = 'N/A';
                        let statusClass = 'status ' + data.status;
                        
                        if (data.expiresAt) {
                            const expiresDate = data.expiresAt.toDate();
                            expiresAt = expiresDate.toLocaleString();
                            
                            // Check if expired
                            if (data.status === 'active' && expiresDate < new Date()) {
                                statusClass = 'status expired';
                            }
                        }
                        
                        const row = `
                            <tr>
                                <td>${data.key}</td>
                                <td><span class="${statusClass}">${data.status}</span></td>
                                <td>${createdAt}</td>
                                <td>${expiresAt}</td>
                                <td>
                                    <button class="action-btn" onclick="revokeKey('${item.id}')">Revoke</button>
                                </td>
                            </tr>
                        `;
                        tbody.innerHTML += row;
                    });
                    
                    // If no active keys, show message
                    if (recentKeys.length === 0) {
                        tbody.innerHTML = `
                            <tr>
                                <td colspan="5" style="text-align: center; color: #aaa;">No active license keys</td>
                            </tr>
                        `;
                    }
                })
                .catch((error) => {
                    console.error("Error loading keys: ", error);
                    const tbody = document.querySelector('#keysTable tbody');
                    tbody.innerHTML = `<tr><td colspan="5" style="color: #ff6b6b; text-align: center;">Error loading keys: ${error.message}</td></tr>`;
                });
        }
        
        // Signal management functions
        function openSignalModal() {
            document.getElementById('signalModal').style.display = 'flex';
        }
        
        function closeSignalModal() {
            document.getElementById('signalModal').style.display = 'none';
            // Clear form
            document.getElementById('signalPair').value = '';
            document.getElementById('signalEntry').value = '';
            document.getElementById('signalTP').value = '';
            document.getElementById('signalSL').value = '';
            document.getElementById('signalNote').value = '';
        }
        
        function saveSignal() {
            const pair = document.getElementById('signalPair').value.trim();
            const type = document.getElementById('signalType').value;
            const entry = document.getElementById('signalEntry').value.trim();
            const tp = document.getElementById('signalTP').value.trim();
            const sl = document.getElementById('signalSL').value.trim();
            const timeframe = document.getElementById('signalTimeframe').value;
            const note = document.getElementById('signalNote').value.trim();
            
            if (!pair || !entry || !tp || !sl) {
                alert('Please fill in all required fields (Pair, Entry, TP, SL)');
                return;
            }
            
            db.collection('signals').add({
                pair: pair,
                type: type,
                entry: entry,
                tp: tp,
                sl: sl,
                timeframe: timeframe,
                note: note,
                status: 'active',
                createdAt: firebase.firestore.FieldValue.serverTimestamp(),
                createdBy: 'admin'
            })
            .then(() => {
                closeSignalModal();
                loadSignals();
                showMessage('Signal added successfully!', 'success');
            })
            .catch((error) => {
                console.error("Error adding signal: ", error);
                showMessage('Error adding signal: ' + error.message, 'error');
            });
        }
        
        function deactivateSignal(signalId) {
            if (!confirm('Are you sure you want to deactivate this signal?')) {
                return;
            }
            
            db.collection('signals').doc(signalId).update({
                status: 'inactive',
                deactivatedAt: firebase.firestore.FieldValue.serverTimestamp()
            })
            .then(() => {
                loadSignals();
                showMessage('Signal deactivated', 'success');
            })
            .catch((error) => {
                console.error("Error deactivating signal: ", error);
                showMessage('Error deactivating signal: ' + error.message, 'error');
            });
        }
        
        function loadSignals() {
            db.collection('signals')
                .get()
                .then((querySnapshot) => {
                    const tbody = document.querySelector('#signalsTable tbody');
                    tbody.innerHTML = '';
                    
                    // Filter and sort client-side (no index needed)
                    const activeSignals = [];
                    querySnapshot.forEach(doc => {
                        const data = doc.data();
                        if (data.status === 'active') {
                            activeSignals.push({id: doc.id, ...data});
                        }
                    });
                    
                    // Sort by createdAt
                    activeSignals.sort((a, b) => {
                        return b.createdAt.seconds - a.createdAt.seconds;
                    });
                    
                    activeSignals.forEach(data => {
                        const createdAt = data.createdAt?.toDate().toLocaleString() || 'N/A';
                        
                        const row = `
                            <tr>
                                <td>${data.pair}</td>
                                <td><span class="signal-type ${data.type}">${data.type.toUpperCase()}</span></td>
                                <td>${data.entry}</td>
                                <td>${data.tp}</td>
                                <td>${data.sl}</td>
                                <td>${data.timeframe}</td>
                                <td>${createdAt}</td>
                                <td>
                                    <button class="action-btn" onclick="deactivateSignal('${data.id}')">Deactivate</button>
                                </td>
                            </tr>
                        `;
                        tbody.innerHTML += row;
                    });
                    
                    // If no signals, show message
                    if (activeSignals.length === 0) {
                        tbody.innerHTML = `
                            <tr>
                                <td colspan="8" style="text-align: center; color: #aaa;">No active signals</td>
                            </tr>
                        `;
                    }
                })
                .catch((error) => {
                    console.error("Error loading signals: ", error);
                    const tbody = document.querySelector('#signalsTable tbody');
                    tbody.innerHTML = `<tr><td colspan="8" style="color: #ff6b6b; text-align: center;">Error loading signals: ${error.message}</td></tr>`;
                });
        }

        function showMessage(text, type = 'error') {
            const messageDiv = document.getElementById('keyMessage') || document.getElementById('message');
            if (!messageDiv) return;
            
            messageDiv.textContent = text;
            messageDiv.style.display = 'block';
            messageDiv.className = type;
            
            setTimeout(() => {
                messageDiv.style.display = 'none';
            }, 5000);
        }
    </script>
</body>
</html>
